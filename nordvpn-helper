#!/bin/bash

# NordVPN Captive Portal Handler - Control Script

PLIST_PATH="$HOME/Library/LaunchAgents/com.user.nordvpn.captiveportal.plist"
SERVICE_NAME="com.user.nordvpn.captiveportal"
TRUSTED_NETWORKS_FILE="$HOME/.nordvpn_trusted_networks"
CMD="nordvpn-helper"

# ── Helper: get current WiFi SSID ─────────────────────────────
current_ssid() {
    /System/Library/PrivateFrameworks/Apple80211.framework/Resources/airport -I 2>/dev/null \
        | awk '/ SSID:/ {print $2}'
}

# ── Helper: resolve SSID from arg or current network ──────────
# Writes to stdout on success; writes error to stderr and returns 1 on failure.
# Call as: SSID=$(resolve_ssid "$2") || exit 1
resolve_ssid() {
    local ssid="$1"
    if [[ -z "$ssid" ]]; then
        ssid=$(current_ssid)
        if [[ -z "$ssid" ]]; then
            echo "Error: Not connected to WiFi and no SSID provided." >&2
            echo "Usage: $CMD trust \"Network Name\"" >&2
            return 1
        fi
    fi
    echo "$ssid"
}

case "$1" in

    # ── Service management ─────────────────────────────────────

    start|enable|on)
        echo "Enabling NordVPN Captive Portal Handler..."
        if [ ! -f "$PLIST_PATH" ]; then
            echo "Error: Launch Agent not found at $PLIST_PATH"
            echo "Please run the installation first."
            exit 1
        fi
        launchctl load "$PLIST_PATH" 2>/dev/null || launchctl load -w "$PLIST_PATH" 2>/dev/null
        sleep 1
        if launchctl list | grep -q "$SERVICE_NAME"; then
            echo "✓ Script enabled and running"
        else
            echo "Warning: Script may not have started. Check logs:"
            echo "  $CMD logs"
        fi
        ;;

    stop|disable|off)
        echo "Disabling NordVPN Captive Portal Handler..."
        launchctl unload "$PLIST_PATH" 2>/dev/null
        sleep 1
        if launchctl list | grep -q "$SERVICE_NAME"; then
            echo "Warning: Script may still be running. Try:"
            echo "  launchctl unload -w $PLIST_PATH"
        else
            echo "✓ Script disabled"
        fi
        ;;

    status|check)
        if launchctl list | grep -q "$SERVICE_NAME"; then
            echo "✓ Script is RUNNING"
            echo ""
            echo "Recent log entries:"
            tail -5 ~/Library/Logs/nordvpn_captive_portal.log 2>/dev/null \
                | sed 's/^/  /' || echo "  No log entries yet"
        else
            echo "✗ Script is STOPPED"
        fi
        echo ""
        if [[ -f "$TRUSTED_NETWORKS_FILE" ]] && [[ -s "$TRUSTED_NETWORKS_FILE" ]]; then
            echo "Trusted networks ($(grep -c . "$TRUSTED_NETWORKS_FILE")):"
            grep -v '^$' "$TRUSTED_NETWORKS_FILE" | sed 's/^/  - /'
        else
            echo "Trusted networks: none"
        fi
        ;;

    restart|reload)
        echo "Restarting NordVPN Captive Portal Handler..."
        launchctl unload "$PLIST_PATH" 2>/dev/null
        sleep 1
        # Relaunch NordVPN so it re-reads the plist with auto-connect disabled
        # and URL schemes are responsive again on a fresh session
        if pgrep -xf "/Applications/NordVPN.app/Contents/MacOS/NordVPN" > /dev/null 2>&1; then
            echo "Restarting NordVPN app..."
            killall NordVPN 2>/dev/null
            sleep 2
            open -a NordVPN
            sleep 4
        fi
        launchctl load "$PLIST_PATH" 2>/dev/null
        sleep 2
        if launchctl list | grep -q "$SERVICE_NAME"; then
            echo "✓ Script restarted"
        else
            echo "Warning: Script may not have restarted. Check logs:"
            echo "  $CMD logs"
        fi
        ;;

    logs)
        echo "Live logs (Ctrl+C to stop):"
        echo ""
        tail -f ~/Library/Logs/nordvpn_captive_portal.log
        ;;

    # ── Trusted network management ─────────────────────────────

    trust)
        # trust [SSID]  — add current or named network to trusted list
        SSID=$(resolve_ssid "$2") || exit 1
        touch "$TRUSTED_NETWORKS_FILE"
        if grep -qxF "$SSID" "$TRUSTED_NETWORKS_FILE" 2>/dev/null; then
            echo "Already trusted: '$SSID'"
        else
            echo "$SSID" >> "$TRUSTED_NETWORKS_FILE"
            echo "✓ Added to trusted networks: '$SSID'"
            echo "  VPN will not connect on this network."
        fi
        # If currently on this network, disconnect VPN immediately
        CURRENT=$(current_ssid)
        if [[ "$CURRENT" == "$SSID" ]]; then
            echo "  Disconnecting VPN (you are on this network now)..."
            osascript -e 'open location "nordvpn://disconnect"' 2>/dev/null
            echo "  Note: if VPN stays connected, restart the service: $CMD restart"
        fi
        ;;

    untrust)
        # untrust [SSID]  — remove current or named network from trusted list
        SSID=$(resolve_ssid "$2") || exit 1
        if [[ ! -f "$TRUSTED_NETWORKS_FILE" ]] || ! grep -qxF "$SSID" "$TRUSTED_NETWORKS_FILE" 2>/dev/null; then
            echo "Not in trusted list: '$SSID'"
        else
            # Remove the line. Use ; not && so mv runs even when grep
            # produces no output (exit 1) — i.e. when removing the last entry.
            grep -vxF "$SSID" "$TRUSTED_NETWORKS_FILE" > "${TRUSTED_NETWORKS_FILE}.tmp"; \
                mv "${TRUSTED_NETWORKS_FILE}.tmp" "$TRUSTED_NETWORKS_FILE"
            echo "✓ Removed from trusted networks: '$SSID'"
            echo "  VPN will now connect on this network."
        fi
        ;;

    trusted)
        # List all trusted networks
        if [[ ! -f "$TRUSTED_NETWORKS_FILE" ]] || [[ ! -s "$TRUSTED_NETWORKS_FILE" ]]; then
            echo "No trusted networks configured."
            echo ""
            echo "To add the current network:  $CMD trust"
            echo "To add a named network:      $CMD trust \"Network Name\""
        else
            CURRENT=$(current_ssid)
            echo "Trusted networks:"
            while IFS= read -r line; do
                [[ -z "$line" ]] && continue
                if [[ "$line" == "$CURRENT" ]]; then
                    echo "  - $line  (currently connected)"
                else
                    echo "  - $line"
                fi
            done < "$TRUSTED_NETWORKS_FILE"
        fi
        ;;

    *)
        echo "NordVPN Captive Portal Handler"
        echo ""
        echo "Service:"
        echo "  $CMD start              Enable and start"
        echo "  $CMD stop               Disable and stop"
        echo "  $CMD status             Show status and trusted networks"
        echo "  $CMD restart            Restart"
        echo "  $CMD logs               View live logs"
        echo ""
        echo "Trusted networks (networks where VPN will NOT connect):"
        echo "  $CMD trust              Trust the current WiFi network"
        echo "  $CMD trust \"Name\"       Trust a specific network by name"
        echo "  $CMD untrust            Remove current WiFi from trusted list"
        echo "  $CMD untrust \"Name\"     Remove a specific network by name"
        echo "  $CMD trusted            List all trusted networks"
        exit 1
        ;;
esac

exit 0
