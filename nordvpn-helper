#!/bin/bash

# NordVPN Captive Portal Handler - Control Script

PLIST_PATH="$HOME/Library/LaunchAgents/com.user.nordvpn.captiveportal.plist"
SERVICE_NAME="com.user.nordvpn.captiveportal"
TRUSTED_NETWORKS_FILE="$HOME/.nordvpn_trusted_networks"
CMD="nordvpn-helper"

# ── Helpers: network identification ───────────────────────────

_get_gateway_ip() {
    route get default 2>/dev/null | awk '/gateway:/{print $2}'
}

_get_router_mac() {
    local gw
    gw=$(_get_gateway_ip)
    [[ -z "$gw" ]] && return
    arp -n "$gw" 2>/dev/null | awk '{print $4}'
}

# Returns a stable, unique identifier for the current network.
# Prefers the Wi-Fi SSID (requires Terminal Location Services on Sequoia).
# Falls back to "gw:<ip>/<router-mac>" — requires no permissions and is
# globally unique (router MAC is a hardware address, never shared between
# networks even when they use the same gateway IP like 192.168.0.1).
current_network_id() {
    local iface
    iface=$(networksetup -listallhardwareports 2>/dev/null \
        | awk '/Wi-Fi/{found=1} found && /Device:/{print $2; exit}')

    if [[ -n "$iface" ]]; then
        local raw
        raw=$(networksetup -getairportnetwork "$iface" 2>/dev/null)
        case "$raw" in
            "Current Wi-Fi Network: "*)
                echo "${raw#Current Wi-Fi Network: }"
                return
                ;;
        esac
        local ssid
        ssid=$(/System/Library/PrivateFrameworks/Apple80211.framework/Resources/airport \
                   -I 2>/dev/null | awk '/ SSID:/ {print $2}')
        [[ -n "$ssid" ]] && { echo "$ssid"; return; }
    fi

    local gw mac
    gw=$(_get_gateway_ip)
    mac=$(_get_router_mac)
    [[ -n "$gw" && -n "$mac" ]] && echo "gw:${gw}/${mac}" && return
    [[ -n "$gw" ]]              && echo "gw:${gw}"
}

current_ssid() { current_network_id; }

# Human-readable label for a network ID
_network_label() {
    local id="$1"
    case "$id" in
        gw:*/*)
            local ip mac
            ip="${id#gw:}"; ip="${ip%/*}"
            mac="${id##*/}"
            echo "router $ip  (MAC $mac)"
            ;;
        gw:*)
            echo "gateway ${id#gw:}  (MAC unknown — re-run 'trust' to upgrade)"
            ;;
        subnet:*)
            echo "subnet ${id#subnet:}  (any gateway in this range)"
            ;;
        *)
            echo "'$id'  (SSID)"
            ;;
    esac
}

# Returns true if the current gateway IP falls within a CIDR range
_ip_in_subnet() {
    local ip="$1" cidr="$2"
    local net="${cidr%/*}" bits="${cidr#*/}"
    local a b c d
    IFS=. read -r a b c d <<< "$ip"
    local ip_int=$(( (a<<24) + (b<<16) + (c<<8) + d ))
    IFS=. read -r a b c d <<< "$net"
    local net_int=$(( (a<<24) + (b<<16) + (c<<8) + d ))
    local mask=$(( (0xFFFFFFFF << (32 - bits)) & 0xFFFFFFFF ))
    [[ $(( ip_int & mask )) -eq $(( net_int & mask )) ]]
}

# ── Helper: resolve SSID from arg or current network ──────────
# Writes to stdout on success; writes error to stderr and returns 1 on failure.
# Call as: SSID=$(resolve_ssid "$2") || exit 1
resolve_ssid() {
    local ssid="$1"
    if [[ -z "$ssid" ]]; then
        ssid=$(current_ssid)
        if [[ -z "$ssid" ]]; then
            echo "Error: Not connected to WiFi and no SSID provided." >&2
            echo "Usage: $CMD trust \"Network Name\"" >&2
            return 1
        fi
    fi
    echo "$ssid"
}

case "$1" in

    # ── Service management ─────────────────────────────────────

    start|enable|on)
        echo "Enabling NordVPN Captive Portal Handler..."
        if [ ! -f "$PLIST_PATH" ]; then
            echo "Error: Launch Agent not found at $PLIST_PATH"
            echo "Please run the installation first."
            exit 1
        fi
        launchctl load "$PLIST_PATH" 2>/dev/null || launchctl load -w "$PLIST_PATH" 2>/dev/null
        sleep 1
        if launchctl list | grep -q "$SERVICE_NAME"; then
            echo "✓ Script enabled and running"
        else
            echo "Warning: Script may not have started. Check logs:"
            echo "  $CMD logs"
        fi
        ;;

    stop|disable|off)
        echo "Disabling NordVPN Captive Portal Handler..."
        launchctl unload "$PLIST_PATH" 2>/dev/null
        sleep 1
        if launchctl list | grep -q "$SERVICE_NAME"; then
            echo "Warning: Script may still be running. Try:"
            echo "  launchctl unload -w $PLIST_PATH"
        else
            echo "✓ Script disabled"
        fi
        ;;

    status|check)
        if launchctl list | grep -q "$SERVICE_NAME"; then
            echo "✓ Script is RUNNING"
            echo ""
            echo "Recent log entries:"
            tail -5 ~/Library/Logs/nordvpn_captive_portal.log 2>/dev/null \
                | sed 's/^/  /' || echo "  No log entries yet"
        else
            echo "✗ Script is STOPPED"
        fi
        echo ""
        CURRENT=$(current_network_id)
        GW=$(_get_gateway_ip); MAC=$(_get_router_mac)
        if [[ -n "$CURRENT" ]]; then
            LABEL=$(_network_label "$CURRENT")
            # Trusted if exact match OR bare gw:IP matches (backwards compat)
            TRUSTED=false
            grep -qxF "$CURRENT"            "$TRUSTED_NETWORKS_FILE" 2>/dev/null && TRUSTED=true
            [[ -n "$GW" && -n "$MAC" ]] && grep -qxF "gw:${GW}/${MAC}" "$TRUSTED_NETWORKS_FILE" 2>/dev/null && TRUSTED=true
            [[ -n "$GW" ]]              && grep -qxF "gw:${GW}"         "$TRUSTED_NETWORKS_FILE" 2>/dev/null && TRUSTED=true
            if $TRUSTED; then
                echo "Current network: $LABEL  ✓ trusted — VPN will not connect"
            else
                echo "Current network: $LABEL  (not trusted — VPN will connect)"
            fi
        else
            echo "Current network: not connected"
        fi
        echo ""
        if [[ -f "$TRUSTED_NETWORKS_FILE" ]] && [[ -s "$TRUSTED_NETWORKS_FILE" ]]; then
            echo "Trusted networks ($(grep -c . "$TRUSTED_NETWORKS_FILE")):"
            grep -v '^$' "$TRUSTED_NETWORKS_FILE" | sed 's/^/  - /'
        else
            echo "Trusted networks: none"
        fi
        ;;

    restart|reload)
        echo "Restarting NordVPN Captive Portal Handler..."
        launchctl unload "$PLIST_PATH" 2>/dev/null
        sleep 1
        # Relaunch NordVPN so it re-reads the plist with auto-connect disabled
        # and URL schemes are responsive again on a fresh session
        if pgrep -xf "/Applications/NordVPN.app/Contents/MacOS/NordVPN" > /dev/null 2>&1; then
            echo "Restarting NordVPN app..."
            killall NordVPN 2>/dev/null
            sleep 2
            open -a NordVPN
            sleep 4
        fi
        launchctl load "$PLIST_PATH" 2>/dev/null
        sleep 2
        if launchctl list | grep -q "$SERVICE_NAME"; then
            echo "✓ Script restarted"
        else
            echo "Warning: Script may not have restarted. Check logs:"
            echo "  $CMD logs"
        fi
        ;;

    logs)
        echo "Live logs (Ctrl+C to stop):"
        echo ""
        tail -f ~/Library/Logs/nordvpn_captive_portal.log
        ;;

    # ── Trusted network management ─────────────────────────────

    trust)
        # trust [SSID]  — add current or named network to trusted list
        SSID=$(resolve_ssid "$2") || exit 1
        touch "$TRUSTED_NETWORKS_FILE"
        if grep -qxF "$SSID" "$TRUSTED_NETWORKS_FILE" 2>/dev/null; then
            echo "Already trusted: '$SSID'"
        else
            echo "$SSID" >> "$TRUSTED_NETWORKS_FILE"
            echo "✓ Added to trusted networks: '$SSID'"
            echo "  VPN will not connect on this network."
        fi
        # If currently on this network, disconnect VPN immediately
        CURRENT=$(current_ssid)
        if [[ "$CURRENT" == "$SSID" ]]; then
            echo "  Disconnecting VPN (you are on this network now)..."
            osascript -e 'open location "nordvpn://disconnect"' 2>/dev/null
            echo "  Note: if VPN stays connected, restart the service: $CMD restart"
        fi
        ;;

    trust-subnet)
        # trust-subnet CIDR  — trust any network whose gateway falls in the range
        # e.g.: nordvpn-helper trust-subnet 10.0.0.0/8
        CIDR="$2"
        if [[ -z "$CIDR" ]]; then
            echo "Usage: $CMD trust-subnet CIDR"
            echo "Example: $CMD trust-subnet 10.0.0.0/8"
            echo ""
            echo "Use this for mesh or enterprise networks where each access point"
            echo "may have a different gateway IP but all fall within the same subnet."
            echo ""
            GW=$(_get_gateway_ip)
            [[ -n "$GW" ]] && echo "Your current gateway IP is: $GW"
            exit 1
        fi
        # Basic CIDR format validation
        if ! [[ "$CIDR" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+/[0-9]+$ ]]; then
            echo "Error: '$CIDR' is not a valid CIDR range (e.g. 10.0.0.0/8)"
            exit 1
        fi
        touch "$TRUSTED_NETWORKS_FILE"
        ENTRY="subnet:$CIDR"
        if grep -qxF "$ENTRY" "$TRUSTED_NETWORKS_FILE" 2>/dev/null; then
            echo "Already trusted: subnet $CIDR"
        else
            echo "$ENTRY" >> "$TRUSTED_NETWORKS_FILE"
            echo "✓ Added to trusted networks: subnet $CIDR"
            echo "  VPN will not connect on any network whose gateway is in this range."
        fi
        # Check if current gateway is already in this subnet
        GW=$(_get_gateway_ip)
        if [[ -n "$GW" ]] && _ip_in_subnet "$GW" "$CIDR"; then
            echo "  Current gateway $GW is in this subnet — disconnecting VPN..."
            osascript -e 'open location "nordvpn://disconnect"' 2>/dev/null
        fi
        ;;

    untrust-subnet)
        CIDR="$2"
        if [[ -z "$CIDR" ]]; then
            echo "Usage: $CMD untrust-subnet CIDR"
            exit 1
        fi
        ENTRY="subnet:$CIDR"
        if ! grep -qxF "$ENTRY" "$TRUSTED_NETWORKS_FILE" 2>/dev/null; then
            echo "Not in trusted list: subnet $CIDR"
        else
            grep -vxF "$ENTRY" "$TRUSTED_NETWORKS_FILE" > "${TRUSTED_NETWORKS_FILE}.tmp"; \
                mv "${TRUSTED_NETWORKS_FILE}.tmp" "$TRUSTED_NETWORKS_FILE"
            echo "✓ Removed from trusted networks: subnet $CIDR"
        fi
        ;;

    untrust)
        # untrust [SSID]  — remove current or named network from trusted list
        SSID=$(resolve_ssid "$2") || exit 1
        if [[ ! -f "$TRUSTED_NETWORKS_FILE" ]] || ! grep -qxF "$SSID" "$TRUSTED_NETWORKS_FILE" 2>/dev/null; then
            echo "Not in trusted list: '$SSID'"
        else
            # Remove the line. Use ; not && so mv runs even when grep
            # produces no output (exit 1) — i.e. when removing the last entry.
            grep -vxF "$SSID" "$TRUSTED_NETWORKS_FILE" > "${TRUSTED_NETWORKS_FILE}.tmp"; \
                mv "${TRUSTED_NETWORKS_FILE}.tmp" "$TRUSTED_NETWORKS_FILE"
            echo "✓ Removed from trusted networks: '$SSID'"
            echo "  VPN will now connect on this network."
        fi
        ;;

    diagnose)
        echo "nordvpn-helper diagnostics"
        echo "══════════════════════════"
        echo ""

        # NordVPN
        if [ -d /Applications/NordVPN.app ]; then
            echo "✓ NordVPN installed"
        else
            echo "✗ NordVPN not found at /Applications/NordVPN.app"
        fi

        # Handler running
        if launchctl list | grep -q "$SERVICE_NAME"; then
            echo "✓ Handler is running"
        else
            echo "✗ Handler is not running  →  nordvpn-helper start"
        fi

        # WiFi interface
        WIFI_IFACE=$(networksetup -listallhardwareports 2>/dev/null \
            | awk '/Wi-Fi/{found=1} found && /Device:/{print $2; exit}')
        if [[ -n "$WIFI_IFACE" ]]; then
            echo "✓ Wi-Fi interface: $WIFI_IFACE"
        else
            echo "✗ No Wi-Fi interface found"
        fi

        # Network ID detection
        NETID=$(current_network_id)
        if [[ "$NETID" == gw:*/* ]]; then
            echo "✓ Network ID: $(_network_label "$NETID")"
            echo "  (SSID unavailable — using router MAC as unique identifier)"
            echo "  To also enable SSID reading (optional):"
            echo "    System Settings → Privacy & Security → Location Services"
            echo "    → System Services → Details → Wi-Fi Networking → ON"
        elif [[ "$NETID" == gw:* ]]; then
            echo "~ Network ID: $(_network_label "$NETID")"
            echo "  Gateway IP alone is not unique. Re-run '$CMD trust' to upgrade"
            echo "  this entry to use the router MAC address for reliable identification."
        elif [[ -n "$NETID" ]]; then
            echo "✓ Network ID: '$NETID' (SSID)"
        else
            echo "  Not connected to any network"
        fi

        # Canary
        if ping -c 1 -W 2 google.com > /dev/null 2>&1; then
            echo "✓ Canary (google.com) reachable — internet is up"
        else
            echo "✗ Canary (google.com) unreachable — captive portal or no internet"
        fi

        # VPN connect URL scheme
        echo ""
        echo "URL scheme test (nordvpn://connect — watch NordVPN UI):"
        echo "  Run: osascript -e 'open location \"nordvpn://connect\"'"
        ;;

    trusted)
        # List all trusted networks
        CURRENT=$(current_network_id)
        GW=$(_get_gateway_ip); MAC=$(_get_router_mac)
        if [[ ! -f "$TRUSTED_NETWORKS_FILE" ]] || [[ ! -s "$TRUSTED_NETWORKS_FILE" ]]; then
            echo "No trusted networks configured."
            echo ""
            echo "To add the current network:  $CMD trust"
            echo "To add a named network:      $CMD trust \"Network Name\""
        else
            NAME_ENTRIES=$(grep -v '^gw:' "$TRUSTED_NETWORKS_FILE" 2>/dev/null | grep -v '^subnet:' | grep -v '^$' || true)
            if [[ "$CURRENT" == gw:* ]] && [[ -n "$NAME_ENTRIES" ]]; then
                echo "Warning: SSID is unreadable on this machine (macOS Sequoia without"
                echo "Location Services). These name-based entries won't match until you"
                echo "reconnect to each network and run '$CMD trust' to add a gateway entry:"
                echo "$NAME_ENTRIES" | sed 's/^/  ! /'
                echo ""
            fi
            echo "Trusted networks:"
            while IFS= read -r line; do
                [[ -z "$line" ]] && continue
                label=$(_network_label "$line")
                is_current=false
                [[ "$line" == "$CURRENT" ]] && is_current=true
                [[ -n "$GW" && -n "$MAC" && "$line" == "gw:${GW}/${MAC}" ]] && is_current=true
                [[ -n "$GW" && "$line" == "gw:${GW}" ]] && is_current=true
                if [[ "$line" == subnet:* && -n "$GW" ]]; then
                    _ip_in_subnet "$GW" "${line#subnet:}" && is_current=true
                fi
                if $is_current; then
                    echo "  - $label  ← currently connected"
                else
                    echo "  - $label"
                fi
            done < "$TRUSTED_NETWORKS_FILE"
        fi
        ;;

    *)
        echo "NordVPN Captive Portal Handler"
        echo ""
        echo "Service:"
        echo "  $CMD start              Enable and start"
        echo "  $CMD stop               Disable and stop"
        echo "  $CMD status             Show status and trusted networks"
        echo "  $CMD restart            Restart"
        echo "  $CMD logs               View live logs"
        echo "  $CMD diagnose           Check permissions and SSID detection"
        echo ""
        echo "Trusted networks (networks where VPN will NOT connect):"
        echo "  $CMD trust                   Trust the current network (by router MAC)"
        echo "  $CMD trust \"Name\"            Trust a network by SSID name"
        echo "  $CMD trust-subnet 10.0.0.0/8 Trust any gateway in a subnet (mesh networks)"
        echo "  $CMD untrust                 Remove current network from trusted list"
        echo "  $CMD untrust \"Name\"          Remove a specific entry"
        echo "  $CMD untrust-subnet 10.0.0.0/8  Remove a subnet entry"
        echo "  $CMD trusted                 List all trusted networks"
        exit 1
        ;;
esac

exit 0
