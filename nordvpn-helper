#!/bin/bash

# NordVPN Captive Portal Handler - Control Script

PLIST_PATH="$HOME/Library/LaunchAgents/com.user.nordvpn.captiveportal.plist"
SERVICE_NAME="com.user.nordvpn.captiveportal"
TRUSTED_NETWORKS_FILE="$HOME/.nordvpn_trusted_networks"
CMD="nordvpn-helper"

# ── Helper: current network identifier ────────────────────────
# Returns the Wi-Fi SSID when Location Services allows it (macOS Sequoia+),
# or falls back to "gw:<gateway-ip>" which needs no special permissions.
current_network_id() {
    local iface
    iface=$(networksetup -listallhardwareports 2>/dev/null \
        | awk '/Wi-Fi/{found=1} found && /Device:/{print $2; exit}')

    if [[ -n "$iface" ]]; then
        local raw
        raw=$(networksetup -getairportnetwork "$iface" 2>/dev/null)
        case "$raw" in
            "Current Wi-Fi Network: "*)
                echo "${raw#Current Wi-Fi Network: }"
                return
                ;;
        esac
        # airport fallback for older macOS
        local ssid
        ssid=$(/System/Library/PrivateFrameworks/Apple80211.framework/Resources/airport \
                   -I 2>/dev/null | awk '/ SSID:/ {print $2}')
        [[ -n "$ssid" ]] && { echo "$ssid"; return; }
    fi

    # Fall back to gateway IP — no permissions needed, unique per router
    local gw
    gw=$(route get default 2>/dev/null | awk '/gateway:/{print $2}')
    [[ -n "$gw" ]] && echo "gw:$gw"
}

# Alias used in older parts of the script
current_ssid() { current_network_id; }

# ── Helper: resolve SSID from arg or current network ──────────
# Writes to stdout on success; writes error to stderr and returns 1 on failure.
# Call as: SSID=$(resolve_ssid "$2") || exit 1
resolve_ssid() {
    local ssid="$1"
    if [[ -z "$ssid" ]]; then
        ssid=$(current_ssid)
        if [[ -z "$ssid" ]]; then
            echo "Error: Not connected to WiFi and no SSID provided." >&2
            echo "Usage: $CMD trust \"Network Name\"" >&2
            return 1
        fi
    fi
    echo "$ssid"
}

case "$1" in

    # ── Service management ─────────────────────────────────────

    start|enable|on)
        echo "Enabling NordVPN Captive Portal Handler..."
        if [ ! -f "$PLIST_PATH" ]; then
            echo "Error: Launch Agent not found at $PLIST_PATH"
            echo "Please run the installation first."
            exit 1
        fi
        launchctl load "$PLIST_PATH" 2>/dev/null || launchctl load -w "$PLIST_PATH" 2>/dev/null
        sleep 1
        if launchctl list | grep -q "$SERVICE_NAME"; then
            echo "✓ Script enabled and running"
        else
            echo "Warning: Script may not have started. Check logs:"
            echo "  $CMD logs"
        fi
        ;;

    stop|disable|off)
        echo "Disabling NordVPN Captive Portal Handler..."
        launchctl unload "$PLIST_PATH" 2>/dev/null
        sleep 1
        if launchctl list | grep -q "$SERVICE_NAME"; then
            echo "Warning: Script may still be running. Try:"
            echo "  launchctl unload -w $PLIST_PATH"
        else
            echo "✓ Script disabled"
        fi
        ;;

    status|check)
        if launchctl list | grep -q "$SERVICE_NAME"; then
            echo "✓ Script is RUNNING"
            echo ""
            echo "Recent log entries:"
            tail -5 ~/Library/Logs/nordvpn_captive_portal.log 2>/dev/null \
                | sed 's/^/  /' || echo "  No log entries yet"
        else
            echo "✗ Script is STOPPED"
        fi
        echo ""
        CURRENT=$(current_network_id)
        if [[ -n "$CURRENT" ]]; then
            if [[ "$CURRENT" == gw:* ]]; then
                LABEL="gateway ${CURRENT#gw:} (SSID unavailable — no Location Services permission)"
            else
                LABEL="'$CURRENT'"
            fi
            if [[ -f "$TRUSTED_NETWORKS_FILE" ]] && grep -qxF "$CURRENT" "$TRUSTED_NETWORKS_FILE" 2>/dev/null; then
                echo "Current network: $LABEL  ✓ trusted — VPN will not connect"
            else
                echo "Current network: $LABEL  (not trusted — VPN will connect)"
            fi
        else
            echo "Current network: not connected"
        fi
        echo ""
        if [[ -f "$TRUSTED_NETWORKS_FILE" ]] && [[ -s "$TRUSTED_NETWORKS_FILE" ]]; then
            echo "Trusted networks ($(grep -c . "$TRUSTED_NETWORKS_FILE")):"
            grep -v '^$' "$TRUSTED_NETWORKS_FILE" | sed 's/^/  - /'
        else
            echo "Trusted networks: none"
        fi
        ;;

    restart|reload)
        echo "Restarting NordVPN Captive Portal Handler..."
        launchctl unload "$PLIST_PATH" 2>/dev/null
        sleep 1
        # Relaunch NordVPN so it re-reads the plist with auto-connect disabled
        # and URL schemes are responsive again on a fresh session
        if pgrep -xf "/Applications/NordVPN.app/Contents/MacOS/NordVPN" > /dev/null 2>&1; then
            echo "Restarting NordVPN app..."
            killall NordVPN 2>/dev/null
            sleep 2
            open -a NordVPN
            sleep 4
        fi
        launchctl load "$PLIST_PATH" 2>/dev/null
        sleep 2
        if launchctl list | grep -q "$SERVICE_NAME"; then
            echo "✓ Script restarted"
        else
            echo "Warning: Script may not have restarted. Check logs:"
            echo "  $CMD logs"
        fi
        ;;

    logs)
        echo "Live logs (Ctrl+C to stop):"
        echo ""
        tail -f ~/Library/Logs/nordvpn_captive_portal.log
        ;;

    # ── Trusted network management ─────────────────────────────

    trust)
        # trust [SSID]  — add current or named network to trusted list
        SSID=$(resolve_ssid "$2") || exit 1
        touch "$TRUSTED_NETWORKS_FILE"
        if grep -qxF "$SSID" "$TRUSTED_NETWORKS_FILE" 2>/dev/null; then
            echo "Already trusted: '$SSID'"
        else
            echo "$SSID" >> "$TRUSTED_NETWORKS_FILE"
            echo "✓ Added to trusted networks: '$SSID'"
            echo "  VPN will not connect on this network."
        fi
        # If currently on this network, disconnect VPN immediately
        CURRENT=$(current_ssid)
        if [[ "$CURRENT" == "$SSID" ]]; then
            echo "  Disconnecting VPN (you are on this network now)..."
            osascript -e 'open location "nordvpn://disconnect"' 2>/dev/null
            echo "  Note: if VPN stays connected, restart the service: $CMD restart"
        fi
        ;;

    untrust)
        # untrust [SSID]  — remove current or named network from trusted list
        SSID=$(resolve_ssid "$2") || exit 1
        if [[ ! -f "$TRUSTED_NETWORKS_FILE" ]] || ! grep -qxF "$SSID" "$TRUSTED_NETWORKS_FILE" 2>/dev/null; then
            echo "Not in trusted list: '$SSID'"
        else
            # Remove the line. Use ; not && so mv runs even when grep
            # produces no output (exit 1) — i.e. when removing the last entry.
            grep -vxF "$SSID" "$TRUSTED_NETWORKS_FILE" > "${TRUSTED_NETWORKS_FILE}.tmp"; \
                mv "${TRUSTED_NETWORKS_FILE}.tmp" "$TRUSTED_NETWORKS_FILE"
            echo "✓ Removed from trusted networks: '$SSID'"
            echo "  VPN will now connect on this network."
        fi
        ;;

    diagnose)
        echo "nordvpn-helper diagnostics"
        echo "══════════════════════════"
        echo ""

        # NordVPN
        if [ -d /Applications/NordVPN.app ]; then
            echo "✓ NordVPN installed"
        else
            echo "✗ NordVPN not found at /Applications/NordVPN.app"
        fi

        # Handler running
        if launchctl list | grep -q "$SERVICE_NAME"; then
            echo "✓ Handler is running"
        else
            echo "✗ Handler is not running  →  nordvpn-helper start"
        fi

        # WiFi interface
        WIFI_IFACE=$(networksetup -listallhardwareports 2>/dev/null \
            | awk '/Wi-Fi/{found=1} found && /Device:/{print $2; exit}')
        if [[ -n "$WIFI_IFACE" ]]; then
            echo "✓ Wi-Fi interface: $WIFI_IFACE"
        else
            echo "✗ No Wi-Fi interface found"
        fi

        # Network ID detection
        NETID=$(current_network_id)
        if [[ "$NETID" == gw:* ]]; then
            GW="${NETID#gw:}"
            echo "~ Network ID: gateway $GW (SSID unavailable)"
            echo "  SSID reading requires Location Services for Terminal on macOS Sequoia."
            echo "  The gateway IP fallback is used instead — trusted networks still work."
            echo "  To enable SSID reading (optional):"
            echo "    System Settings → Privacy & Security → Location Services"
            echo "    → System Services → Details → Wi-Fi Networking → ON"
        elif [[ -n "$NETID" ]]; then
            echo "✓ Network ID: '$NETID' (SSID)"
        else
            echo "  Not connected to any network"
        fi

        # Canary
        if ping -c 1 -W 2 google.com > /dev/null 2>&1; then
            echo "✓ Canary (google.com) reachable — internet is up"
        else
            echo "✗ Canary (google.com) unreachable — captive portal or no internet"
        fi

        # VPN connect URL scheme
        echo ""
        echo "URL scheme test (nordvpn://connect — watch NordVPN UI):"
        echo "  Run: osascript -e 'open location \"nordvpn://connect\"'"
        ;;

    trusted)
        # List all trusted networks
        if [[ ! -f "$TRUSTED_NETWORKS_FILE" ]] || [[ ! -s "$TRUSTED_NETWORKS_FILE" ]]; then
            echo "No trusted networks configured."
            echo ""
            echo "To add the current network:  $CMD trust"
            echo "To add a named network:      $CMD trust \"Network Name\""
        else
            CURRENT=$(current_network_id)
            echo "Trusted networks:"
            while IFS= read -r line; do
                [[ -z "$line" ]] && continue
                if [[ "$line" == gw:* ]]; then
                    label="${line}  (by gateway IP)"
                else
                    label="$line"
                fi
                if [[ "$line" == "$CURRENT" ]]; then
                    echo "  - $label  ← currently connected"
                else
                    echo "  - $label"
                fi
            done < "$TRUSTED_NETWORKS_FILE"
        fi
        ;;

    *)
        echo "NordVPN Captive Portal Handler"
        echo ""
        echo "Service:"
        echo "  $CMD start              Enable and start"
        echo "  $CMD stop               Disable and stop"
        echo "  $CMD status             Show status and trusted networks"
        echo "  $CMD restart            Restart"
        echo "  $CMD logs               View live logs"
        echo "  $CMD diagnose           Check permissions and SSID detection"
        echo ""
        echo "Trusted networks (networks where VPN will NOT connect):"
        echo "  $CMD trust              Trust the current WiFi network"
        echo "  $CMD trust \"Name\"       Trust a specific network by name"
        echo "  $CMD untrust            Remove current WiFi from trusted list"
        echo "  $CMD untrust \"Name\"     Remove a specific network by name"
        echo "  $CMD trusted            List all trusted networks"
        exit 1
        ;;
esac

exit 0
